# データ構造

### 1.1 データを理解する

データの構造を知るまえに、データそのものを理解することが重要です。可視化するもととなるデータが、そもそも何なのか、どのような情報を持っているのかを調べることがまず大切です。

例えば、下記のよう果物屋のECサイトの注文履歴データがあったとします。まず、調べることは、データのサイズの確認、カラムの意味、データの粒度を調べることです。

| id | cu\_id | ord\_dt | ord\_id | ord\_detail | ord\_no | fruit\_id | fruit | price | unit | subtotal |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | X001 | 2018-12-01 | ord-01 | ord-01-01 | 1 | p001 | Apple | 100 | 1 | 100 |
| 2 | X001 | 2019-04-01 | ord-02 | ord-02-02 | 1 | p002 | Orange | 100 | 2 | 200 |
| 3 | **X002** | **2018-12-10** | **ord-03** | **ord-03-01** | **1** | **p001** | **Apple** | 100 | 1 | 400 |
| 4 | **X002** | **2018-12-10** | **ord-03** | **ord-03-02** | **2** | **p002** | **Orange** | 100 | 3 | 400 |
| 5 | X002 | 2019-01-04 | ord-04 | ord-04-01 | 1 | p005 | Peach | 300 | 1 | 300 |
| 6 | X003 | 2019-01-04 | ord-05 | ord-05-01 | 1 | p001 | Apple | 100 | 2 | 200 |
| 7 | **X003** | **2019-02-07** | **ord-06** | **ord-06-01** | 1 | p003 | Banana | 150 | 3 | 850 |
| 8 | **X003** | **2019-02-07** | **ord-07** | **ord-07-01** | 1 | p001 | Apple | 100 | 4 | 850 |
| 9 | X004 | 2019-04-01 | ord-08 | ord-08-01 | 1 | p004 | grape | 250 | 2 | 500 |
| 10 | X005 | 2019-02-25 | ord-09 | ord-09-01 | 1 | p001 | Apple | 100 | 2 | 200 |

#### 1.1.1データのサイズ

はじめにデータのサイズを確認します。このデータのサイズは10行×11列のデータです。または10レコード、5カラムのデータです。このようなテーブル\(表\)を表現する際に、行のことはロー\(Row\)、列のことはカラム\(Colmun\)と呼びます。データ分析の世界では、ローとカラムは使い分けられているので、正しい用語を使ってください。

#### 1.1.2 カラムの意味

次にカラムの意味を確認していきましょう。データベースの設計者でなければわからないこともあるので、そのようなカラムは設計者に定義を確認します。もしくはテーブル定義書を参考にします。

* `id`：レコード順で、連番が振られている数字です。
* `cu_id`：4桁の会員IDで5人の会員がいる。
* `ord_dt`：注文日で、日付は入っているが日時はない。
* `ord_id`：注文を識別するIDで、1つの注文をまとめる単位になっている。
* `ord_detail`：1つの注文に対する詳細を表すID。
* `ord_no`：1つの注文に対する詳細番号を表すID。
* `fruit_id`：商品のIDで、果物を識別するID。
* `fruit_name`：商品の名前。
* `price`：商品の単価。
* `unit`：商品の個数。
* `subtotal`：1つの注文に対する合計金額。

例えば、3、4行目に注目すると、`cuid=002`は`ord_dt=2018-12-10`に2回買っているのではなく、1回の注文で2商品買っていることがわかります。

一方で、7、8行目に注目すると、`cuid=X003`は`ord_dt=2019-02-27`に、1回の注文を2回していることがわかります。これは、`ord_id`や`ord_detail`を見ればわかります。

`subtotal`に注目すると、1つの注文に対する合計金額が記録されているので、このカラムを使って合計金額をカウントすると、1つの注文で複数行をもつレコードの数分、金額が重複して合計されてしますので、誤った集計になります。

この履歴データから下記のようなことが、集計できることがわかりますし、会員の属性情報を紐付ければ、属性ごとの集計も可能です。

* 何人の会員が注文しているのか。
* どの果物が何個売れているのか。
* 果物の合計金額はいくらか。
* 会員はいつ注文をして、何回購入しているのか。　etc...

#### 1.1.3 データの粒度

データの粒度とは、**データを一意\(Unique\)に特定するためのカラムの組み合わせ**のことです。言い換えれば、このカラムを使えば、1行を特定できるということです。今回の例だと、`id`がレコードごとに振られているので、このカラムを使えばレコードを一意に特定できます。つまり、`id=8`と言われたときに、どのレコードを指しているのかがわかります。また、`ord_detail`も、どのIDを指定されてもレコードを特定できます。

例えば、`cu_id`はどうでしょうか。`cu_id=X001`と言われても、1行目か2行目のいずれのレコードなのか特定できません。

また、今回のようなサンプルデータのように必ずしも、レコードを特定できるカラムがあるわけではありません。下記のように`id`や`ord_detail`がない場合はどうでしょうか。この場合、`ord_id`と`ord_no`を組み合わせることで、レコードを特定できます。このようにレコードを一意に特定できることで、`price`が何のカラムかわからんくても単価だと推測できます。最終的にはデータベースの設計者に確認します。

| cu\_id | ord\_dt | ord\_id | ord\_no | fruit\_id | fruit | price | unit | subtotal |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| X001 | 2018-12-01 | ord-01 | 1 | p001 | Apple | 100 | 1 | 100 |
| X001 | 2019-04-01 | ord-02 | 1 | p002 | Orange | 100 | 2 | 200 |
| **X002** | **2018-12-10** | **ord-03** | **1** | **p001** | **Apple** | 100 | 1 | 400 |
| **X002** | **2018-12-10** | **ord-03** | **2** | **p002** | **Orange** | 100 | 3 | 400 |
| X002 | 2019-01-04 | ord-04 | 1 | p005 | Peach | 300 | 1 | 300 |
| X003 | 2019-01-04 | ord-05 | 1 | p001 | Apple | 100 | 2 | 200 |
| **X003** | **2019-02-07** | **ord-06** | 1 | p003 | Banana | 150 | 3 | 850 |
| **X003** | **2019-02-07** | **ord-07** | 1 | p001 | Apple | 100 | 4 | 850 |
| X004 | 2019-04-01 | ord-08 | 1 | p004 | grape | 250 | 2 | 500 |
| X005 | 2019-02-25 | ord-09 | 1 | p001 | Apple | 100 | 2 | 200 |

大抵は、データベースの設計者がレコードを特定できるように、データベースは設計されますが、そうではない欠陥のあるデータベースがあることも事実です。

### 1.2 データの種類

世の中のデータベースのテーブルの種類をわけると、「履歴データ」と「マスタデータ」にわけられます。違いは色々とありますが、常に最新の更新済みデータが反映されているのがマスタデータで、履歴として記録を残しておくデータが履歴\(トランザクション\)データです。履歴データは、いつ、誰が、何を、何個注文し、単価はいくら、などの情報を時系列に記録しています。

下記は会員マスタデータのサンプルです。常に最新の更新済みデータが反映されているのがマスタデータなので、`X001`が2行、3行あることはありえませんが、データベースの設計が誤っている場合は、存在する場合がありますので、データのサイズの確認、カラムの意味、データの粒度を調べることは、どんなデータでも大切です。

| cu\_id | lastname | birthday | gender | area | rank |
| :--- | :--- | :--- | :--- | :--- | :--- |
| X001 | Tanaka | 2000-01-05 | M | Osaka | S |
| X002 | Suzuki | null | F | Kyoto | C |
| X003 | Sato | 2002-08-03 | null | Nara | B |
| X004 | Nakata | 1989-09-26 | F | Kyoto | A |
| X005 | Kaneda | 1983-10-21 | M | Tokyo | null |



